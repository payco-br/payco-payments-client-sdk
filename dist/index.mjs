import*as x from"valibot";import*as t from"valibot";import{cnpj as I,cpf as v}from"cpf-cnpj-validator";var l=(o=>(o.Mastercard="mastercard",o.Visa="visa",o.Amex="amex",o.Hipercard="hipercard",o.Elo="elo",o))(l||{}),u=t.object({holderName:t.string([t.regex(/^[a-zA-Z\s]+$/),t.minLength(2)]),holderDocument:t.string([t.custom(e=>!!(v.isValid(e)||I.isValid(e)),"invalid document, must be a valid CPF or CNPJ")]),number:t.string([t.regex(/^\d{16}$/),t.custom(e=>{let n=e[0];return!e.split("").every(r=>r===n)},"invalid card number, must be a valid credit card number")]),cardBrand:t.enum_(l),expirationMonth:t.string([t.regex(/^(0[1-9]|1[0-2])$/)]),expirationYear:t.string([t.regex(/^\d{2}$/)]),cvv:t.string([t.regex(/^\d{3}$/)])});import h from"axios";function y({baseURL:e}){return h.create({baseURL:e})}import{CompactEncrypt as w,importSPKI as k}from"jose";async function m({card:e,publicKey:n,keyId:r,verifyCard:a}){let i=new TextEncoder().encode(JSON.stringify({card_number:e.number,brand:e.cardBrand,card_holder_name:e.holderName,expiration_month:e.expirationMonth,expiration_year:e.expirationYear,verify_card:a,security_code:e.cvv})),o=await k(`-----BEGIN PUBLIC KEY-----
${n}
-----END PUBLIC KEY-----`,"RSA-OAEP-256");return{encryptedCard:await new w(i).setProtectedHeader({alg:"RSA-OAEP-256",enc:"A256GCM",kid:r}).encrypt(o)}}function g(){return{http_accept_browser_value:navigator.userAgent,http_accept_content:navigator.accept,http_browser_language:navigator.language,http_browser_java_enabled:navigator?.javaEnabled()||!1,http_browser_javascript_enabled:!0,http_browser_color_depth:window.screen.colorDepth,http_browser_screen_height:window.screen.height,http_browser_screen_width:window.screen.width,http_browser_time_difference:new Date().getTimezoneOffset().toString(),user_agent_browser_value:navigator.userAgent}}async function f({keyId:e,client:n}){try{return{publicKey:(await n.get(`api/v1/payments/card/public_key/${e}`)).data.public_key}}catch(r){throw console.error("Error getting public key",r),r}}function _({orgId:e,sessionId:n}){let r=n??window.crypto.randomUUID(),a=document.body,i=document.createElement("script");i.id="adiq",i.type="text/javascript",i.src=`https://h.online-metrix.net/fp/tags.js?org_id=${e}&session_id=adiq_br${r}`,a.appendChild(i);let o=document.createElement("script");o.type="text/javascript",o.id="kdtjs",o.async=!0,o.src="https://i.k-analytix.com/k.js",a.appendChild(o);let d=`
		<noscript>
			<iframe
				style="width: 100px; height: 100px; border: 0; position:absolute; top: -5000px;"
				src="https://h.online-metrix.net/fp/tags.js?org_id=${e}&session_id=adiq_br${r}"
			></iframe>
		</noscript>`;return a.insertAdjacentHTML("beforeend",d),r}async function b({encryptedCard:e,client:n}){try{return{token:(await n.post("/api/v1/payments/card/token",{token:e})).data.card_vault_token}}catch{throw new Error("Error trying to tokenize card data")}}function T(){return Konduto.getVisitorID()}function R(e){return Konduto.setCustomerID(e)}function U(e,n){Konduto.sendEvent(e,n)}var c,p,s;globalThis.__kdt=[];var F=async e=>{if(!e.keyId)throw new Error("keyId is required");let n=e.baseURL||"https://api.payments.payco.com.br/open";c=y({baseURL:n}),p=e.keyId;let r=e.orgId||"k8vif92e";if(typeof window>"u"){s=e.sessionId??crypto.randomUUID();return}if(e.installScripts??!0)__kdt.push({public_key:r},{post_on_load:!1}),s=_({orgId:r,sessionId:e.sessionId});else{if(!e.sessionId)throw new Error("sessionId is required when installScripts is false");s=e.sessionId}},J=async({cardData:e,verifyCard:n=!1})=>{let r=x.parse(u,e),{publicKey:a}=await f({client:c,keyId:p}),{encryptedCard:i}=await m({card:r,publicKey:a,keyId:p,verifyCard:n});return await b({encryptedCard:i,client:c})},Z=()=>{if(typeof window>"u")throw new Error("getDeviceInfo() must be called in the browser (or a window context)");return g()};export{U as addPageTag,c as client,Z as getDeviceInfo,T as getVisitorID,F as initialize,p as keyId,s as sessionId,R as setCustomerID,J as tokenize};
